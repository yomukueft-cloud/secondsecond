<!doctype html>
<meta charset="utf-8">
<title>7-5′ Platform Landing</title>
<canvas id="cv" width="640" height="360" style="background:#0e1528"></canvas>
<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

// ── オブジェクト ─────────────────────────
const player = { x: 80, y: 260, w: 28, h: 36 };

const playerImage = new Image();
playerImage.src = 'pngwing.com.png'; 
let imageLoaded = false;
playerImage.onload = () => {
    imageLoaded = true;
    };

const floor  = { x: 0,  y: 320, w: 640, h: 40 };
const plat   = { x: 360, y: 240, w: 160, h: 16 }; // 浮遊足場

// ─ 動く足場 ─
const plat2 = { x: 100, y: 150, w: 100, h: 16, vx: 100, dir: 1 };
// ─ トラップオブジェクト ─
const trap   = { x:220, y:304, w:28, h:16, color:'#f65b6a' }; // 触れるとアウト
// ─ ゴールオブジェクトとゴール状態管理変数 ─ // ★追加
const goal   = { x:580, y:284, w:40, h:36, color:'#f8e05d' };
let reached=false;

// ── 物理パラメータ ────────────────────────
let vx = 0    // 横方向の移動速度
let vy = 0;
const speed = 240;   // 地上での移動速度(px/s)
const jump  = 700;   // ジャンプ初速(px/s)
const g     = 2000;  // 重力加速度(px/s^2)
let isGrounded = false;

// ── 入力 ──────────────────────────────────
const keys = {};
addEventListener('keydown', e => keys[e.key] = true);   // イベントリスナ、第2引数はアロー関数
addEventListener('keyup',   e => keys[e.key] = false);  // イベントリスナ、第２引数はアロー関数
addEventListener('keydown', e=>{
  // 地上にいるときだけジャンプ
  if (e.code === 'Space' && isGrounded) vy = -jump;     // パラメータを使用
});

// ── 当たり判定ユーティリティ（AABB） ──────
function aabb(r1, r2) {
  return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
          r1.y < r2.y + r2.h && r1.y + r1.h > r2.y);
}

// ── 衝突処理：床 ──────────────────────────
function collideWithFloor() {
  const bottom = player.y + player.h;
  if (bottom > floor.y) {
    player.y = floor.y - player.h; // 吸着
    vy = 0;
    isGrounded = true;
  }
}

// ── 衝突処理：浮遊足場（上からのみ着地） ──
function collideWithPlatform(dt) {
  // 今フレームの矩形
  const pNow = { x: player.x, y: player.y, w: player.w, h: player.h };
  if (!aabb(pNow, plat)) return; // そもそも重なっていない

  // 前フレームの“底”が足場の上面より上にあったなら「上から来た」とみなす
  const prevBottom = (player.y - vy * dt) + player.h;
  const platformTop = plat.y;

  if (prevBottom <= platformTop && vy >= 0) {
    // 上から着地
    player.y = platformTop - player.h; // 吸着
    vy = 0;
    isGrounded = true;
  } else {
    // 横や下から来た場合は「乗れない」簡易仕様：今回は処理しない（すり抜け）
    // 発展：横からのめり込み解除や天井衝突を入れると完成度が上がる
  }
}

// ── 移動処理：動く足場 ────────────────
function movePlatform2(dt) {
  plat2.x += plat2.vx * plat2.dir * dt;
  if (plat2.x < 50 || plat2.x + plat2.w > 590) plat2.dir *= -1;
}

// ── 衝突処理：動く足場 ────────────────
function collideWithPlatform2(dt){
  if (!aabb(player, plat2)) return;
  const prevBottom = (player.y - vy*dt) + player.h;
  if (prevBottom <= plat2.y && vy >= 0){
    // 上から着地＆足場と一緒に動く
    player.y = plat2.y - player.h;
    vy = 0;
    isGrounded = true;
    player.x += plat2.vx * plat2.dir * dt; // 乗っている間は運ばれる
  }
}

// ── 衝突処理：トラップ ────────────────
function checkTrap() {
  if (aabb(player, trap)) {
    // 当たったら初期位置へ
    player.x = 100;
    player.y = 100;
    vy = 0;
  }
}

// ── 衝突処理：ゴール ────────────────// ★追加
function checkGoal() {
  if (aabb(player, goal)) reached = true;
}

// ── 位置更新 ──────────────────────────────────
function update(dt){
  // 入力 → 水平方向速度（簡略：即時切替）
  vx = 0;
  if (keys['a'])  vx = -speed;
  if (keys['d']) vx =  speed;
  
  player.x += vx * dt;
  vy += g * dt;            // 重力で速度が増える
  player.y += vy * dt;     // 位置更新

  // 衝突判定（毎フレーム isGrounded をリセットしてから判定）
  isGrounded = false;

  collideWithFloor();
  collideWithPlatform(dt);
  collideWithPlatform2(dt);
  movePlatform2(dt);
  checkTrap();
  checkGoal();    // ★追加
}

// ── 描画 ──────────────────────────────────
function draw() {
  ctx.clearRect(0,0,cv.width,cv.height);

  // 床
  ctx.fillStyle = '#203060';
  ctx.fillRect(floor.x, floor.y, floor.w, floor.h);

  // 浮遊足場
  ctx.fillStyle = '#2e446e';
  ctx.fillRect(plat.x, plat.y, plat.w, plat.h);

  // 動く足場
  ctx.fillStyle='#4468cc';
  ctx.fillRect(plat2.x, plat2.y, plat2.w, plat2.h);

  // trap
  ctx.fillStyle=trap.color;
  ctx.fillRect(trap.x, trap.y, trap.w, trap.h);

  // ゴールオブジェクト　★追加
  ctx.fillStyle = goal.color;
  ctx.fillRect(goal.x, goal.y, goal.w, goal.h);

  // ゴールの状態管理変数を使ってゴール状態を表示する　★追加
  if (reached) {
    ctx.fillStyle = '#fff';
    ctx.font = '28px sans-serif';
    ctx.fillText('Goal!', 270, 180);
  }
 // プレイヤー（画像を描画）
  if (imageLoaded) {
    ctx.drawImage(playerImage, player.x, player.y, player.w, player.h);
  } else {
    ctx.fillStyle = isGrounded ? '#7ef5e1' : '#ffd166';
    ctx.fillRect(player.x, player.y, player.w, player.h);
  }
  // HUD
  ctx.fillStyle = '#cbd5e1';
  ctx.font = '12px ui-monospace,monospace';
  ctx.fillText(`vy=${vy.toFixed(1)} grounded=${isGrounded}`, 8, 16);
}

// ── ループ ─────────────────────────────────
let last = performance.now();
function loop(now) {
  const dt = (now - last) / 1000; last = now;

  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
